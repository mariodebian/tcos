#!/bin/sh

HOST=$1


if [ "$HOST" = "" ]; then
  HOST=$(echo $DISPLAY | awk -F":" '{print $1}')
fi


if [ ! -x /usr/bin/bootchart ]; then
  echo "ERROR:"
  echo ""
  echo "  Please install bootchart-view package"
  exit 1
fi

OUT=$(pwd)
TGZ=$HOME/tcos-genbootchart/bootchart.tgz

mkdir -p $HOME/tcos-genbootchart/mnt

_exit() {
  fusermount -u $HOME/tcos-genbootchart/mnt
  rm -rf $HOME/tcos-genbootchart
  exit $1
}


ltspfs ${HOST}:/tmp $HOME/tcos-genbootchart/mnt
if [ $? -gt 0 ]; then
  echo "Error mounting remote LTSPFS"
  _exit 1
fi

if [ ! -d $HOME/tcos-genbootchart/mnt/bootchart ]; then
  echo "/tmp/bootchart not found on remote host"
  _exit 1
fi

( cd $HOME/tcos-genbootchart/mnt/bootchart && tar -czf ${TGZ} *)

bootchart ${TGZ} -o ${OUT}

_exit 0
