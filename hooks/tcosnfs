#!/bin/bash

PREREQ=""

prereqs()
{
	echo "$PREREQ"
}

case $1 in
# get pre-requisites
prereqs)
	prereqs
	exit 0
	;;
esac



# Hooks for install binaries for tcos boot
#
. /usr/share/initramfs-tools/hook-functions

# read conf file => /etc/tcos/initramfs.conf
. $CONFDIR/initramfs.conf

# read from env vars TCOS_BOOT
TCOS_BOOT=$(env| awk -F "=" '/^TCOS_BOOT=/ {print $2}')
if [ "${TCOS_BOOT}" != "" ]; then
  BOOT=$TCOS_BOOT
fi

if [ "${BOOT}" = "tcos-nfs" ]; then

. $CONFDIR/tcos.conf
. $TCOS_DIR/tcos-generation-functions.sh


# copy internal tcos conf
cp $TCOS_DIR/tcos-run-functions.sh   $DESTDIR/conf/tcos-run-functions
cp $CONFDIR/tcos.conf                $DESTDIR/conf/



# usplash support
mkdir -p $DESTDIR/usr/lib/usplash/
if [ -f /usr/lib/usplash/${TCOS_USPLASH} ]; then
  cp /usr/lib/usplash/${TCOS_USPLASH} $DESTDIR/usr/lib/usplash/usplash-artwork.so > /dev/null 2>&1
else
  cp /usr/lib/usplash/usplash-tcos.so $DESTDIR/usr/lib/usplash/usplash-artwork.so > /dev/null 2>&1
fi


# load some hook-addons (not all needed here, we need a minimal image)
TCOS_INCLUDE_INIT=1
. ${TCOS_DIR}/hooks-addons/00init  
unset TCOS_INCLUDE_INIT
. ${TCOS_DIR}/hooks-addons/00main
. ${TCOS_DIR}/hooks-addons/00users
. ${TCOS_DIR}/hooks-addons/01dhclient
. ${TCOS_DIR}/hooks-addons/01busybox
. ${TCOS_DIR}/hooks-addons/02hex2ascii
. ${TCOS_DIR}/hooks-addons/03udev2
. ${TCOS_DIR}/hooks-addons/03wireless
. ${TCOS_DIR}/hooks-addons/06funionfs
. ${TCOS_DIR}/hooks-addons/06nbd_filesystem
. ${TCOS_DIR}/hooks-addons/90usplash
. ${TCOS_DIR}/hooks-addons/95usplash_timeout
. ${TCOS_DIR}/hooks-addons/99clean_nfs_image


manual_add_modules unionfs
manual_add_modules aufs

fi
