# this file copies tcosxmlrpc server into initramfs
# and adds startup scripts of tcosxmlrpc server

stat_before

# EJECT for mount/umount cdrom
copy_exec /usr/bin/eject /usr/bin/


# SCROT package
copy_exec /usr/bin/scrot /usr/bin/
mkdir -p $DESTDIR/usr/lib/imlib2/filters/
mkdir -p $DESTDIR/usr/lib/imlib2/loaders/
cpifexists /usr/lib/imlib2/loaders/png.so        /usr/lib/imlib2/loaders/
cpifexists /usr/lib/imlib2/loaders/gif.so        /usr/lib/imlib2/loaders/

# screenshot script and webserver
cpifexists ${TCOS_BINS}/screenshot.sh     /sbin/
cpifexists ${TCOS_BINS}/useallmodules.sh  /sbin/
cpifexists ${TCOS_BINS}/devicesctl.sh  /sbin/

cpifexists ${TCOS_BINS}/soundctl.sh /sbin/

cpifexists ${TCOS_BINS}/starthttpd.sh        /sbin/
cpifexists /usr/share/initramfs-tools-tcos/xmlrpc/httpd2.conf       /etc/

# udev process
cpifexists ${TCOS_BINS}/tcos-udevd.sh           /sbin/
mkdir -p ${DESTDIR}/etc/udev/rules.d/
cpifexists /usr/share/initramfs-tools-tcos/xmlrpc/050_tcos_devices.rules  /etc/udev/rules.d/

# with new kernels (>= 2.6.22) need mount/umount events
cpifexists ${TCOS_BINS}/mount-listener           /usr/sbin/
cpifexists ${TCOS_BINS}/listener-daemon.sh       /usr/sbin/

# need udevinfo in listener-daemon.sh
cpifexists /usr/bin/udevinfo                     /usr/bin/


# tcosxmlrpc utils
cpifexists ${TCOS_BINS}/tcosxmlrpc  /usr/bin/
cpifexists ${TCOS_BINS}/lockscreen  /usr/bin/

# copy locked image
mkdir -p ${DESTDIR}/usr/share/tcos-core/
cp /usr/share/tcos-core/lockscreen.png ${DESTDIR}/usr/share/tcos-core/

if [ -e /sbin/start-stop-daemon.REAL ]; then
  # cdebootstrap diverts to .REAL this file
  copy_exec /sbin/start-stop-daemon.REAL  /sbin/
  rm -f $DESTDIR/sbin/start-stop-daemon.REAL
  cp -a /sbin/start-stop-daemon.REAL $DESTDIR/sbin/start-stop-daemon
else
  copy_exec /sbin/start-stop-daemon  /sbin/
fi

cpifexists ${TCOS_BINS}/getinfo.sh       /sbin/
chmod +x $DESTDIR/sbin/getinfo.sh

# fixed in initramfs-tools-tcos 0.60
#copy_exec /usr/bin/seq             /bin/



cat << EOF >  $DESTDIR/sbin/restartx
#!/bin/sh

restartxorg &
exit 0
EOF
chmod +x $DESTDIR/sbin/restartx


# pci database
copy_exec /usr/bin/lspci /usr/bin/
mkdir -p $DESTDIR/usr/share/misc/
cpifexists /usr/share/misc/pci.ids /usr/share/misc/



cpifexists /usr/share/initramfs-tools-tcos/xmlrpc/abyss.conf     /etc/
cpifexists /usr/share/initramfs-tools-tcos/xmlrpc/mime.types     /etc/

# configure /etc/abyss.conf
# abs path of mime.types
sed -i s/"etc"/"\/etc"/g ${DESTDIR}/etc/abyss.conf

# configure user
sed -i s/"nobody"/"root"/g ${DESTDIR}/etc/abyss.conf

mkdir -p $DESTDIR/var/log
mkdir -p $DESTDIR/var/www

# add launcher
cat << EOF > $DESTDIR/sbin/startxmlrpc
#!/bin/sh
cd /
/usr/bin/tcosxmlrpc /etc/abyss.conf >> /var/log/tcosxmlrpc.log 2>&1
exit 0
EOF
chmod +x $DESTDIR/sbin/startxmlrpc


stat_after "TcosMonitor"
