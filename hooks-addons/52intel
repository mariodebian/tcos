# hook for intel graphics card
# Copyright Rubén Gómez Antolí <listas at mucharuina [.] com>

# test if we have intel-drv or i810
if [ -e /usr/lib/xorg/modules/drivers/i810_drv.so ] && \
   [ ! -L /usr/lib/xorg/modules/drivers/i810_drv.so ]; then

    # we have OLD driver, need 915resolution
    if [ ! -x /usr/sbin/915resolution ]; then
        if [ ! -e /etc/tcos/disable915 ]; then
            _echo "    WARNING:"
            _echo "      Detected old INTEL graphic driver (i810)"
            _echo ""
            _echo "      Install 915resolution to support full resolutions for intel cards"
            _echo ""
            _echo "      If you don't want to see this warning again,"
            _echo "      create and empty file  =>  /etc/tcos/disable915"
            _echo ""
        fi
    else
        stat_before
        cpifexists /usr/sbin/915resolution    /usr/bin/
        cpifexists /usr/sbin/vbetool          /usr/bin/
        cpifexists /usr/bin/tac               /usr/bin/
        
        if [ -f /etc/tcos/915resolution ]; then
            cpifexists /etc/tcos/915resolution    /etc/default/
            _echo "    * INTEL, using /etc/tcos/915resolution as conf file"
        else
            cpifexists /etc/default/915resolution /etc/default/
            _echo "    * INTEL, using /etc/default/915resolution as conf file"
        fi
        
        stat_after "Intel 915 resolution hack"
    fi
else
  _verbose "(52intel) Not doing INTEL hack "
fi


cat << EOF > $DESTDIR/sbin/disable_dpms
#!/bin/sh

# wait for Xorg
while [ "\$(pidof Xorg)" = "" ] ; do
 sleep 2
done

# disable dpms
sleep 2
xset -dpms

EOF
chmod +x $DESTDIR/sbin/disable_dpms


cat << EOF > $DESTDIR/etc/X11/PreRun/30intel_dpms
#!/bin/sh

if [ "$(lspci |grep VGA|grep -i intel)" ]; then
  /sbin/disable_dpms &
fi

EOF

