# this hook is called before mkinitramfs is called

. /etc/tcos/tcos.conf
. /usr/share/initramfs-tools/hook-functions
. $TCOS_DIR/tcos-generation-functions.sh

_verbose "(clean_initramfs) Cleaning initramfs..."



if [ "${DESTDIR}" = "" ] || [ "$DESTDIR" = "/" ]; then
  _echo "  * ERROR: DESTDIR var not set. not cleaning initramfs..."
  exit 1
fi

find $DESTDIR/etc/ -name "*dpkg-old" | xargs rm -f

# replace /bin/sh => /bin/busybox
rm -f $DESTDIR/bin/sh
(cd $DESTDIR/bin && ln -s busybox sh)


# zattoo provides libasound.so.2 link in /usr/lib/zattoo that breaks sound support
# move to their site
if [ -e $DESTDIR/usr/lib/zattoo/libasound.so.2 ]; then
  mv $DESTDIR/usr/lib/zattoo/libasound.so.2 $DESTDIR/usr/lib/libasound.so.2
  rmdir $DESTDIR/usr/lib/zattoo/
fi

if [ $TCOS_DISABLE_ACPI ] ; then

  #rm -rf $DESTDIR/bin/sh*
  #( cd ${DESTDIR}/bin/ && ln -s busybox sh )

  rm -rf $DESTDIR/scripts/usb*
  rm -rf $DESTDIR/scripts/live*
  rm -rf $DESTDIR/scripts/local*
  rm -rf $DESTDIR/scripts/casper*
  rm -rf $DESTDIR/scripts/nfs*
  rm -rf $DESTDIR/scripts/init-premount/thermal
  rm -rf $DESTDIR/sbin/mdadm
  rm -rf $DESTDIR/sbin/mdrun
  rm -rf $DESTDIR/sbin/vgchange
  rm -rf $DESTDIR/sbin/cryptsetup
  rm -rf $DESTDIR/sbin/dmsetup
  rm -rf $DESTDIR/lib/lvm*
  rm -rf ${DESTDIR}/lib/modules/${TCOS_KERNEL}/kernel/drivers/md/
  rm -rf ${DESTDIR}/lib/modules/${TCOS_KERNEL}/drivers/md/
  rm -rf ${DESTDIR}/lib/modules/${TCOS_KERNEL}/drivers/acpi/

#  rm -rf $(find ${DESTDIR}/lib/modules/${TCOS_KERNEL}/kernel/drivers/scsi/ \
#	-not -name "sd_mod.ko" -not -name "sr_mod.ko" \
#	-not -name "scsi_mod.ko" -not -name "sg.ko" )


fi


if [ "$TCOS_DISABLE_USPLASH" = "1" ]; then
  _echo "  * Remove usplash"
  rm -f ${DESTDIR}/lib/usplash
  rm -f ${DESTDIR}/sbin/usplash
  rm -f ${DESTDIR}/sbin/usplash_write
  rm -f ${DESTDIR}/scripts/init-top/*usplash*
fi

# experimental delete, not needed LIBS
rm -f ${DESTDIR}/sbin/resume
rm -f ${DESTDIR}/usr/lib/libgcrypt.so.11
rm -f ${DESTDIR}/usr/lib/libpcre.so.3
rm -f ${DESTDIR}/usr/lib/libgpg-error.so.0
rm -f ${DESTDIR}/usr/lib/libGL.so.1.2
rm -f ${DESTDIR}/usr/lib/libGLU.so.1
rm -f ${DESTDIR}/usr/lib/libkrb5support.so.0
rm -f ${DESTDIR}/usr/lib/libfusion-1.0.so.0
#rm -f ${DESTDIR}/usr/lib/libdrm.so.2
rm -f ${DESTDIR}/usr/lib/libdirectfb-1.0.so.0
rm -f ${DESTDIR}/usr/lib/libnvidia-tls.so.1
rm -f ${DESTDIR}/usr/lib/libdirect-1.0.so.0
rm -f ${DESTDIR}/usr/lib/libk5crypto.so.3
rm -f ${DESTDIR}/usr/lib/libkrb5.so.3
rm -f ${DESTDIR}/usr/lib/libXxf86vm.so.1
rm -f ${DESTDIR}/usr/lib/libglib-2.0.so.0
rm -f ${DESTDIR}/usr/lib/imlib2/loaders/png.so
rm -f ${DESTDIR}/usr/lib/libgssapi_krb5.so.2
#rm -f ${DESTDIR}/lib/libsplashycnf.so.1
rm -f ${DESTDIR}/lib/libkeyutils.so.1
#rm -f ${DESTDIR}/lib/libsplashy.so.1

