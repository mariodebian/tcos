# hooks addon to export USB devices with USB/IP
# need usbip-tools and modules

# I have put no-exists to disable usbip (not work yet)
# but I want to provide code
#if [ -x /usr/bin/usbipd-noexists ]; then
if [ -x /usr/bin/usbip ]; then

   stat_before

    cpifexists /usr/bin/usbip         /usr/bin
    cpifexists /usr/bin/usbipd        /usr/bin
    cpifexists /usr/bin/bind_driver   /usr/bin

    cpifexists /usr/bin/lsusb         /usr/bin

    mkdir -p $DESTDIR/usr/share/
    cp -ra /usr/share/usbip $DESTDIR/usr/share/

    manual_add_modules usbip_common_mod
    manual_add_modules usbip
    manual_add_modules vhci-hcd


   cat << EOF > $DESTDIR/scripts/tcos-bottom/70usbip
#!/bin/sh
#

# new header not using prereqs
if [ "\$1" = "prereqs" ]; then
  echo ""
  exit 0
fi


quiet=n
. /scripts/functions
. /conf/tcos.conf
. /conf/tcos-run-functions

log_begin_msg "Starting USB/IP"
  mkdir -p /usr/share/hwdata
  mkdir -p /var/lib/usbutils
  ln -s /usr/share/usbip/usb.ids /usr/share/hwdata 2>/dev/null
  ln -s /usr/share/usbip/usb.ids /var/lib/usbutils

  modprobe usbip_common_mod
  modprobe usbip

  usbipd -D > /var/log/usbipd.log 2>&1
log_end_msg $?

exit 0
EOF
   chmod +x $DESTDIR/scripts/tcos-bottom/70usbip 

   stat_after "** EXPERIMENTAL ** USB/IP support"

fi

