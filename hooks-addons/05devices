# hooks addon to use terminal devices
# need autofs and ltspfs
# ltspfs
# TCOS_REMOTEFS = shfs ltspfs

create_launcher() {
    cat << EOF > $DESTDIR/bin/ltspfs-set-xprop
#!/bin/sh
# wait for Xorg

if [ "\$1" != "now" ]; then
  time1=2
  time2=5
else 
  time1=0
  time2=0
fi

while [ "\$(pidof Xorg | sed '/^\$/d')" = "" ] ; do
 sleep \$time1
 echo "ltspfs-set-xprop::waiting for Xorg"
done

# wait until Xorg is complety started
sleep \$time2
echo "ltspfs-set-xprop::setting xprop value"

export DISPLAY=:0 
export XAUTHORITY=/root/.Xauthority
echo "xprop -root -f LTSPFS_TOKEN 8s -set LTSPFS_TOKEN \$(cat /var/run/ltspfs_token)"
xprop -root -f LTSPFS_TOKEN 8s -set LTSPFS_TOKEN \$(cat /var/run/ltspfs_token)

exit 0
EOF
   chmod +x $DESTDIR/bin/ltspfs-set-xprop
}

warn_if_no_match_versions() {
  if [ -e /usr/bin/ltspfs ] && [ "$(strings /usr/bin/ltspfs |grep -c -i ltspfs_token)" = 0 ]; then
   _echo "  * ERROR:"
   _echo ""
   _echo "  LTSPFS have 2 different versions in boot image and server."
   _echo "    Please install the same version or devices will not work."
   _echo ""
   _echo "   ltspfsd-core + ltspfs"
   _echo ""
   _echo "            or"
   _echo ""
   _echo "  ltspfs-client + ltspfs-server"
  fi
}

if [ "$TCOS_REMOTEFS" = "ltspfs" ]; then

  create_launcher
  cpifexists /usr/bin/xprop   /usr/bin/

  if [ -d ${TCOS_PKG_CACHE}/ltspfsd/ ]; then
   stat_before
     cpifexists ${TCOS_PKG_CACHE}/ltspfsd/usr/bin/ltspfsd /usr/bin
     if [ "$(strings `readlink $DESTDIR/usr/bin/ltspfsd` |grep -c ltspfs_token)" != 0 ]; then
       _echo "   * ltspfsd new auth version > 0.5"
       warn_if_no_match_versions
     fi
   stat_after "ltspfsd [cached]"

  elif [ -e /usr/bin/ltspfsd ]; then
   stat_before
   cpifexists /usr/bin/ltspfsd /usr/bin
     if [ "$(strings `readlink $DESTDIR/usr/bin/ltspfsd` |grep -c ltspfs_token)" != 0 ]; then
       _echo "   * ltspfsd new auth version > 0.5"
       warn_if_no_match_versions
     fi
   stat_after "ltspfsd"

  else
   echo "ERROR:"
   echo ""
   echo "Not LTSPFS support, please install ltspfsd or cache it."
   echo "    # gentcos -instpkg ltspfsd"
   echo ""
   echo ""
  fi
fi

if [ $TCOS_NTFS_3G ]; then
   stat_before
    # copy ntfs-3g bin and force load fuse
    cpifexists /usr/bin/ntfs-3g /usr/bin/
    echo "/usr/bin/ntfs-3g /sbin/mount.ntfs-3g" >> $DESTDIR/conf/links
    manual_add_modules fuse
    echo "fuse" >> $DESTDIR/etc/modules
   stat_after "NTFS-3G tools"
fi


if [ ! $TCOS_AUTOFS ]; then
  _verbose "(05devices) TCOS_AUTOFS disabled"
else
  if [ -d /usr/share/doc/autofs ]; then
   echo "ERROR"
   echo ""
   echo "No autofs support, please install autofs package."
   echo "  => apt-get install autofs"
   echo ""
  else
   # autofs
   stat_before
   cpifexists /usr/sbin/automount     /sbin/
   mkdir -p $DESTDIR/usr/lib/autofs
   copydir /usr/lib/autofs/          /usr/lib/
   mkdir -p $DESTDIR/var/run/autofs
   stat_after "Autofs mounter"
  fi
fi

