# hooks addon to use terminal devices
# need autofs and ltspfs
# ltspfs
# TCOS_REMOTEFS = shfs ltspfs

create_launcher() {
    cat << EOF > $DESTDIR/bin/ltspfs-set-xprop
#!/bin/sh
# wait for Xorg

if [ "\$1" != "now" ]; then
  time1=2
  time2=5
else 
  time1=0
  time2=0
fi

while [ "\$(pidof Xorg | sed '/^\$/d')" = "" ] ; do
 sleep \$time1
 echo "ltspfs-set-xprop::waiting for Xorg"
done

# wait until Xorg is complety started
sleep \$time2
echo "ltspfs-set-xprop::setting xprop value"

export DISPLAY=:0 
export XAUTHORITY=/root/.Xauthority
echo "xprop -root -f LTSPFS_TOKEN 8s -set LTSPFS_TOKEN \$(cat /var/run/ltspfs_token)"
xprop -root -f LTSPFS_TOKEN 8s -set LTSPFS_TOKEN \$(cat /var/run/ltspfs_token)

exit 0
EOF
   chmod +x $DESTDIR/bin/ltspfs-set-xprop
}



if [ "$TCOS_REMOTEFS" = "ltspfs" ]; then

  create_launcher
  cpifexists /usr/bin/xprop   /usr/bin/

  if [ -d ${TCOS_PKG_CACHE}/ltspfsd/ ]; then
   stat_before
     cpifexists ${TCOS_PKG_CACHE}/ltspfsd/usr/bin/ltspfsd /usr/bin
     if [ "$(strings `readlink $DESTDIR/usr/bin/ltspfsd` |grep -c ltspfs_token)" != 0 ]; then
       _echo "   * ltspfsd new auth version > 0.5"
     fi
   stat_after "ltspfsd [cached]"

  elif [ -e /usr/bin/ltspfsd ]; then
   stat_before
   cpifexists /usr/bin/ltspfsd /usr/bin
     if [ "$(strings `readlink $DESTDIR/usr/bin/ltspfsd` |grep -c ltspfs_token)" != 0 ]; then
       _echo "   * ltspfsd new auth version > 0.5"
     fi
   stat_after "ltspfsd"

  else
   echo "ERROR:"
   echo ""
   echo "Not LTSPFS support, please install ltspfsd or cache it."
   echo "    # gentcos -instpkg ltspfsd"
   echo ""
   echo ""
  fi

elif [ "$TCOS_REMOTEFS" = "shfs" ]; then
  _echo "WARNING:"
  _echo "  SHFS support enabled, server requires shfs kernel module"
  cpifexists /etc/login.defs /etc/
else
 _verbose "(05devices) TCOS_REMOTEFS disabled '$TCOS_REMOTEFS'"
fi


if [ ! $TCOS_AUTOFS ]; then
  _verbose "(05devices) TCOS_AUTOFS disabled"
else
  if [ -d /usr/share/doc/autofs ]; then
   echo "ERROR"
   echo ""
   echo "No autofs support, please install autofs package."
   echo "  => apt-get install autofs"
   echo ""
  else
   # autofs
   stat_before
   cpifexists /usr/sbin/automount     /sbin/
   mkdir -p $DESTDIR/usr/lib/autofs
   copydir /usr/lib/autofs/          /usr/lib/
   mkdir -p $DESTDIR/var/run/autofs
   stat_after "Autofs mounter"
  fi
fi

