# pulseaudio hook
#
# clients must connect in two ways:
#
#  connecting to server:  tcp:thin_client_ip:4713
#     or
#  importing X11 cookie with: $ pax11publish -i
#     or
#  using this env var PULSE_SERVER="thin_client_hostname"

if [ ${TCOS_PULSEAUDIO} ] && [  ${TCOS_SOUND} ]; then

# check for apps
check1=0
[ -x /usr/bin/pulseaudio ] && check1=1

check2=0
[ -e /usr/lib/pulse*/modules/module-esound-protocol-tcp.so ] && check2=1
[ -d ${TCOS_PKG_CACHE}/pulseaudio-esound-compat/usr/lib ] && check2=1

if [ $check1 = 0 ]; then
   echo "    WARNING:"
   echo "      pulseaudio is not installed, disable it from tcos.conf!!!"

elif [ $check2 = 0 ]; then
   echo "    WARNING:"
   echo "      pulseaudio-esound-compat is not installed, need some esound modules"
   echo "      install this package or disable PulseAudio in /etc/tcos/tcos.conf"
   echo "      You can install a cached package with:"
   echo "      # gentcos -instpkg pulseaudio-esound-compat"
   echo ""
   echo "      See /usr/share/doc/gentcos/README.cache"
   echo ""

else


 stat_before

 cpifexists /usr/bin/pulseaudio     /usr/bin/
 cpifexists /usr/bin/pax11publish   /usr/bin/
 cpifexists /usr/bin/pactl          /usr/bin/

 mkdir -p ${DESTDIR}/usr/lib
 copydir /usr/lib/pulse-*   /usr/lib/

 mkdir -p ${DESTDIR}/var/lib/pulse

 # clean unneeded modules
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*.la
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*jack*
 # rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*rtp*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*lirc*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*evdev*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*sine*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*x11-bell*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*zeroconf*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*avahi*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*gconf*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*hal*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*pipe*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*tunel*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*volume-restore*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*cli*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*http*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*console-kit*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*ladspa*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*bluetooth*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*augment*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*phone*
 rm -f ${DESTDIR}/usr/lib/pulse-*/modules/*position-event*

 # needed for pulse -> esound -> OSS
 [ -e /usr/lib/pulse-*/modules/libsocket-client.so ] && \
      cpifexists /usr/lib/pulse-*/modules/libsocket-client.so /usr/lib/pulse-*/modules/

 if [ -d ${TCOS_PKG_CACHE}/pulseaudio-esound-compat/usr/lib/pulse-*/modules ]; then
  _echo "    * PulseAudio copying esound compat [cached] modules..."
  # warn about OLD cached version
  PULSE_LIB_FILE=${TCOS_PKG_CACHE}/pulseaudio-esound-compat/usr/lib/pulse-*/modules/libprotocol-esound.so
  if [ $(_ldd ${PULSE_LIB_FILE} | grep -c -e "libpulsecore" -e "not found") = 0 ]; then
    _echo ""
    _echo "    *** WARNING ***"
    _echo ""
    _echo "       You have a old cached copy of pulseaudio-esound-compat package"
    _echo "       Please remove and reinstall it or sound will not work:"
    _echo ""
    _echo "       gentcos -rmpkg pulseaudio-esound-compat"
    _echo "       gentcos -instpkg pulseaudio-esound-compat"
    _echo ""
  fi
  cp -ra ${TCOS_PKG_CACHE}/pulseaudio-esound-compat/usr/lib/pulse-*/modules/*.so ${DESTDIR}/usr/lib/pulse-*/modules/
 fi


 #copydir /etc/pulse                   /etc/
 mkdir -p $DESTDIR/etc/pulse
 cpifexists /etc/pulse/client.conf     /etc/pulse/
 cpifexists /etc/pulse/daemon.conf     /etc/pulse/

 # limit PulseAudio SHM memory
 if grep -q shm-size-bytes /etc/pulse/daemon.conf; then
   echo "shm-size-bytes = 16"         >> $DESTDIR/etc/pulse/daemon.conf
 fi
 if grep -q disable-shm /etc/pulse/daemon.conf; then
   echo "disable-shm = yes"           >> $DESTDIR/etc/pulse/daemon.conf
 fi

 if [ "$TCOS_SOUND_REMOTE_ESD" ]; then
   _SERVER=";\$(read_server "xdmcp-server")"
 else
   _SERVER=""
 fi


 cat << EOF >> ${DESTDIR}/sbin/startpulseaudio
#!/bin/sh


. /scripts/functions
. /conf/tcos.conf
. /conf/tcos-run-functions



# generate conf
rm -f /etc/pulse/default.pa

if [ "\$(pidof esd | sed '/^\$/d')" != "" ]; then
cat << FIN > /etc/pulse/default.pa
#!/usr/bin/pulseaudio -nF

load-module module-esound-sink server=127.0.0.1
load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1;\$(read_server "xdmcp-server")

.ifexists module-x11-publish.so
.nofail
load-module module-x11-publish
.fail
.endif

FIN

else
cat << FIN > /etc/pulse/default.pa
#!/usr/bin/pulseaudio -nF

load-module module-detect

load-module module-esound-protocol-tcp auth-ip-acl=127.0.0.1$_SERVER
load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1;\$(read_server "xdmcp-server")

load-module module-esound-protocol-unix

.ifexists module-x11-publish.so
.nofail
load-module module-x11-publish
.fail
.endif

.nofail
FIN

fi


DISPLAY=:0
export DISPLAY

cpu=\$(grep MHz /proc/cpuinfo | tail -1 | awk  -F":" '{if(int(\$2) < 1024) printf "low"}')
realtime=\$(pulseaudio --help 2>&1 | grep -c realtime)

OPTS="--log-target=stderr "
if [ \${TCOS_PULSEAUDIO_RESAMPLE_METHOD} ]; then
 OPTS="\${OPTS} --resample-method=\${TCOS_PULSEAUDIO_RESAMPLE_METHOD}"
fi

OPTS="--no-cpu-limit \${OPTS}"

if [ "\$cpu" = "low" ]; then
 #OPTS="--no-cpu-limit \${OPTS}"
 # old versions of pulseaudio don't have realtime switch (Etch)
 if [ "\$realtime" != "0" ]; then
   OPTS="\${OPTS} --realtime "
 fi
fi

_log "STARTPULSEAUDIO starting pulseaudio server..."
pulseaudio  \${OPTS}  &

# exit now, X11 publish is done with a module
exit 0

#sleep 1
#
# wait for Xorg is started
#
#while [ "\$(pidof Xorg | sed '/^\$/d')" = "" ] ; do
# sleep 2
#done
#       
# wait until Xorg is complety started      
#sleep 5
#
#DISPLAY=:0 pax11publish -e
#
#exit 0

EOF
  chmod +x  ${DESTDIR}/sbin/startpulseaudio

  stat_after "PulseAudio (sound server)"

fi # end of else of /usr/bin/pulseaudio

else
  _verbose "(21pulseaudio) TCOS_PULSEAUDIO && sound disabled"
fi # end of TCOS_PULSEAUDIO
