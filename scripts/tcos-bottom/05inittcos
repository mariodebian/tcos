#!/bin/sh
# 

quiet=n

. /scripts/functions
. /conf/tcos.conf
. /conf/tcos-run-functions

# if break=inittcos STOP here
maybe_break inittcos


# Loop over every line in /etc/modules.
# patch from Roberto IbaÃ±ez
grep '^[^#]' /etc/modules | \
while read module args; do
  [ "$module" ] || continue
  modprobe "$module" "$args" >> /tmp/initramfs.debug 2>&1
done


if [ "${TCOS_ROOT_PASSWD}" != "" ]; then
 # setup root passwd
 log_begin_msg "Updating root password"

   [ -e /dev/log ] || mknod /dev/log c 21 5
   rm -f /etc/.pwd.lock

   echo "root:${TCOS_ROOT_PASSWD}" | chpasswd  2>&1 >/dev/null
 log_end_msg $?
else
 _log "INITTCOS not updating root passwd, using generation root passwd"
fi


# load modules
if [ -x /usr/bin/pcimodules ]; then
    for mod in $(pcimodules) ; do
    modprobe -s -k "$mod" > /tmp/initramfs.debug 2>&1 &
    done
fi
# detect Xorg kernel module and driver
# pcimodules --class 0x30000 --classmask 0xffff00 | grep -v fb$



if [ "$(which loadkeys)" ]; then
 _log "INITTCOS loading keymap"
 log_begin_msg "Loading default server keymap"
   loadkeys -q /etc/console/boottime.kmap.gz >> /tmp/initramfs.debug 2>&1 &
 log_end_msg $?
else
 _log "INITTCOS not loading default keymap"
fi





update_progress 2



exit 0
